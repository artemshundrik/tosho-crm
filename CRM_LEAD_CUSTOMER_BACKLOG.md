# CRM Backlog: Лід -> Замовник (уніфікована картка)

## Формат пріоритетів
- P0: критично для запуску функції
- P1: важливо для стабільної роботи після запуску
- P2: покращення

## Оцінка
- Оцінка вказана в engineering days (ed) на 1 розробника, без урахування QA/UAT.

## 1) Migration

| ID | Пріоритет | Задача | Оцінка | Залежності | Результат |
|---|---|---|---:|---|---|
| MIG-01 | P0 | Спроєктувати цільову схему `counterparties` (єдина сутність для lead/customer) + поля договору (`iban`, `signatory_name`, `signatory_position`, `contract_details`) | 0.5 ed | - | Погоджена SQL-схема та mapping зі старих таблиць |
| MIG-02 | P0 | Додати/оновити таблиці `counterparty_reminders`, `counterparty_events`, `counterparty_comments` з FK на `counterparty_id` | 0.5 ed | MIG-01 | Міграція створює потрібні таблиці/індекси |
| MIG-03 | P0 | Додати `counterparty_id` в `calculations` і `orders` (або перевірити існуючі FK та нормалізувати) | 0.5 ed | MIG-01 | Прорахунки/замовлення пов'язані з єдиним контрагентом |
| MIG-04 | P0 | Написати backfill-міграцію: перенесення Лідів і Замовників в єдину сутність, мапінг старих ID -> новий `counterparty_id` | 1.5 ed | MIG-01, MIG-02, MIG-03 | Дані історії перенесені без втрат |
| MIG-05 | P0 | Міграція історичних `calculations`/`orders` на новий `counterparty_id` + звіт по сиротах | 1 ed | MIG-04 | 100% записів прив'язані або задокументовані винятки |
| MIG-06 | P1 | Додати індекси для списків вкладок: `(counterparty_id, created_at desc)` у `calculations`, `orders`, `comments`, `events`, `reminders` | 0.5 ed | MIG-03 | Прийнятна швидкість вкладок на великих даних |
| MIG-07 | P1 | Rollback/verification script для безпечного релізу (dry-run + post-checks) | 0.5 ed | MIG-04, MIG-05 | Є перевірка якості міграції до/після релізу |

## 2) Backend

| ID | Пріоритет | Задача | Оцінка | Залежності | Результат |
|---|---|---|---:|---|---|
| BE-01 | P0 | Оновити доменну модель контрагента: `status = lead | customer`, реквізити договору доступні на обох статусах | 0.5 ed | MIG-01 | Єдина модель у коді без дублювання Lead/Customer DTO |
| BE-02 | P0 | `GET /counterparties/:id` з агрегатами (`calculations_count`, `orders_count`) | 0.5 ed | BE-01 | Картка отримує всю базову інформацію одним запитом |
| BE-03 | P0 | `PATCH /counterparties/:id` для оновлення реквізитів і статусу (з валідаціями) | 0.5 ed | BE-01 | Можна редагувати IBAN/підписанта і статус |
| BE-04 | P0 | `POST /counterparties/:id/convert-to-customer` (ідемпотентний) | 0.5 ed | BE-01 | Ручна конвертація працює без дублювання даних |
| BE-05 | P0 | CRUD для нагадувань: `POST/GET/PATCH/DELETE /counterparties/:id/reminders` | 0.5 ed | MIG-02 | Блок Нагадування повністю функціональний |
| BE-06 | P0 | CRUD для подій: `POST/GET/PATCH/DELETE /counterparties/:id/events` | 0.5 ed | MIG-02 | Блок Події повністю функціональний |
| BE-07 | P0 | CRUD для коментарів: `POST/GET/PATCH/DELETE /counterparties/:id/comments` | 0.5 ed | MIG-02 | Блок Коментарі повністю функціональний |
| BE-08 | P0 | Списки вкладок: `GET /counterparties/:id/calculations` і `GET /counterparties/:id/orders` (пагінація + сортування) | 0.5 ed | MIG-03 | Вкладки Прорахунки/Замовлення мають API |
| BE-09 | P0 | Автоконвертація при створенні першого замовлення для `lead` (транзакційно) | 1 ed | BE-04, BE-08 | Статус змінюється автоматично при першому замовленні |
| BE-10 | P1 | Аудит-лог подій: зміна статусу, зміна реквізитів, створення/видалення reminders/events/comments | 1 ed | BE-03..BE-09 | Вся критична активність відстежується |
| BE-11 | P1 | Політики доступу (RBAC): редагування реквізитів/статусу, видалення коментарів/подій/нагадувань | 0.5 ed | BE-03..BE-07 | Прозорий контроль доступів за ролями |
| BE-12 | P1 | Контрактні тести API (schema + idempotency + edge-cases конвертації) | 1 ed | BE-02..BE-09 | Захист від регресій на інтеграційному рівні |

## 3) Frontend

| ID | Пріоритет | Задача | Оцінка | Залежності | Результат |
|---|---|---|---:|---|---|
| FE-01 | P0 | Уніфікувати UI картки Ліда/Замовника на єдиний компонент `CounterpartyCard` + бейдж статусу | 1 ed | BE-02 | Один екран для обох статусів |
| FE-02 | P0 | Форма реквізитів (IBAN, підписант, інші поля договору) доступна для `lead` і `customer` | 0.5 ed | BE-03 | Реквізити редагуються без зміни статусу |
| FE-03 | P0 | Блок `Нагадування`: список + створення/редагування/видалення | 0.5 ed | BE-05 | Повноцінний UI нагадувань |
| FE-04 | P0 | Блок `Події`: список + створення/редагування/видалення | 0.5 ed | BE-06 | Повноцінний UI подій |
| FE-05 | P0 | Блок `Коментарі`: таймлайн + CRUD | 0.5 ed | BE-07 | Повноцінний UI коментарів |
| FE-06 | P0 | Додати вкладку `Прорахунки` в картку контрагента | 0.5 ed | BE-08 | Видимий список прорахунків у картці |
| FE-07 | P0 | Додати вкладку `Замовлення` в картку контрагента | 0.5 ed | BE-08 | Видимий список замовлень у картці |
| FE-08 | P0 | Кнопка `Конвертувати в Замовника` + підтвердження + обробка станів | 0.5 ed | BE-04 | Ручна конвертація з UI |
| FE-09 | P0 | UX автоконвертації при першому замовленні: toast/банер + оновлення бейджа статусу без перезавантаження | 0.5 ed | BE-09 | Прозора поведінка без плутанини для менеджера |
| FE-10 | P1 | Фільтри/списки контрагентів: `тільки Ліди`, `тільки Замовники`, `всі` | 0.5 ed | BE-01 | Зручна робота у списках після уніфікації |
| FE-11 | P1 | Оптимізація завантаження вкладок (lazy fetch + skeleton + cache invalidation) | 0.5 ed | FE-06, FE-07 | Швидкий UX на великих обсягах даних |
| FE-12 | P1 | E2E сценарії: lead card -> proрахунок -> перше замовлення -> автоконвертація -> customer card | 1 ed | FE-01..FE-09 | Захист ключового флоу від регресій |

## 4) Релізний план (рекомендована послідовність)

1. `Migration`: MIG-01..MIG-05
2. `Backend core`: BE-01..BE-09
3. `Frontend core`: FE-01..FE-09
4. `Stabilization`: MIG-06..MIG-07, BE-10..BE-12, FE-10..FE-12

## 5) Критичний шлях (must-have для першого релізу)

- MIG-01, MIG-02, MIG-03, MIG-04, MIG-05
- BE-01, BE-02, BE-03, BE-04, BE-05, BE-06, BE-07, BE-08, BE-09
- FE-01, FE-02, FE-03, FE-04, FE-05, FE-06, FE-07, FE-08, FE-09

Орієнтовно: **~14-17 ed** на MVP (без QA/UAT, залежно від стану поточного коду і складності фактичної міграції даних).

## 6) Декомпозиція на спринти (опційно)

- Sprint 1: MIG-01..MIG-05, BE-01..BE-04
- Sprint 2: BE-05..BE-09, FE-01..FE-05
- Sprint 3: FE-06..FE-09, hardening (частина P1)
